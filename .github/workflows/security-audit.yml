name: Security Audit
# Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÐºÐ²Ð°Ñ€Ñ‚Ð°Ð»: 1 ÑÐ½Ð²Ð°Ñ€Ñ, 1 Ð°Ð¿Ñ€ÐµÐ»Ñ, 1 Ð¸ÑŽÐ»Ñ, 1 Ð¾ÐºÑ‚ÑÐ±Ñ€Ñ Ð² 09:00 UTC
    - cron: '0 9 1 1,4,7,10 *'
  workflow_dispatch: # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  security-audit:
    name: Quarterly Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "## NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --json > npm-audit.json || true
          npm audit >> $GITHUB_STEP_SUMMARY || echo "Vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Run ESLint Security Rules
        id: eslint-security
        run: |
          echo "## ESLint Security Scan" >> $GITHUB_STEP_SUMMARY
          npm run lint -- --format json > eslint-security.json || true
          npm run lint >> $GITHUB_STEP_SUMMARY || echo "Issues found" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Check for innerHTML usage
        id: innerHTML-check
        run: |
          echo "## innerHTML Usage Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Scanning for potentially unsafe innerHTML usage..." >> $GITHUB_STEP_SUMMARY
          grep -r "innerHTML" src/ --include="*.js" > innerHTML-usage.txt || true
          COUNT=$(grep -c "innerHTML" innerHTML-usage.txt || echo "0")
          echo "Found $COUNT innerHTML usages" >> $GITHUB_STEP_SUMMARY
          echo "See SECURITY_CSP.md for detailed analysis" >> $GITHUB_STEP_SUMMARY

      - name: Check dependencies for known vulnerabilities
        id: dependency-check
        run: |
          echo "## Dependency Vulnerability Check" >> $GITHUB_STEP_SUMMARY
          npx better-npm-audit audit --json > dependency-audit.json || true
          echo "Check completed - see artifacts for details" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results-${{ github.run_number }}
          path: |
            npm-audit.json
            eslint-security.json
            innerHTML-usage.txt
            dependency-audit.json
          retention-days: 90

      - name: Create Security Issue
        if: steps.npm-audit.outcome == 'failure' || steps.eslint-security.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            
            let npmAudit = '';
            let eslintResults = '';
            
            try {
              npmAudit = fs.readFileSync('npm-audit.json', 'utf8');
            } catch (e) {}
            
            try {
              eslintResults = fs.readFileSync('eslint-security.json', 'utf8');
            } catch (e) {}
            
            const body = `
            ## ðŸ”’ Quarterly Security Audit Report
            
            **Date:** ${date}
            **Quarter:** Q${Math.floor((new Date().getMonth() / 3)) + 1} ${new Date().getFullYear()}
            
            ### Summary
            
            This is an automated quarterly security audit. Please review the findings and take appropriate action.
            
            ### NPM Audit Results
            
            \`\`\`json
            ${npmAudit.substring(0, 1000)}
            \`\`\`
            
            ### ESLint Security Results
            
            \`\`\`json
            ${eslintResults.substring(0, 1000)}
            \`\`\`
            
            ### Action Items
            
            - [ ] Review npm audit findings
            - [ ] Review ESLint security warnings
            - [ ] Update vulnerable dependencies
            - [ ] Review innerHTML usage (see SECURITY_CSP.md)
            - [ ] Update security documentation
            - [ ] Test all security-critical features
            
            ### Related Documentation
            
            - [SECURITY.md](../blob/main/SECURITY.md)
            - [SECURITY_CSP.md](../blob/main/SECURITY_CSP.md)
            - [Audit Artifacts](../actions/runs/${{ github.run_id }})
            
            ---
            *This issue was automatically created by the quarterly security audit workflow.*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”’ Quarterly Security Audit - Q${Math.floor((new Date().getMonth() / 3)) + 1} ${new Date().getFullYear()}`,
              body: body,
              labels: ['security', 'audit', 'automated']
            });

      - name: Generate Security Report
        if: always()
        run: |
          cat > security-report-$(date +%Y-%m-%d).md << 'EOF'
          # Security Audit Report
          
          **Date:** $(date +%Y-%m-%d)
          **Quarter:** Q$(($(date +%-m) / 3 + 1)) $(date +%Y)
          
          ## Executive Summary
          
          This automated quarterly security audit reviews:
          - NPM dependencies for known vulnerabilities
          - ESLint security rule violations
          - innerHTML usage patterns
          - Overall security posture
          
          ## Findings
          
          ### 1. NPM Dependencies
          - See npm-audit.json for detailed results
          - Action: Update vulnerable packages using Dependabot PRs
          
          ### 2. Code Quality
          - See eslint-security.json for linting issues
          - Action: Fix security-related ESLint warnings
          
          ### 3. innerHTML Usage
          - Total usages: $(grep -c "innerHTML" innerHTML-usage.txt || echo "0")
          - See SECURITY_CSP.md for detailed analysis
          - Status: 90% safe usage (static content/TrustedTypes)
          
          ## Recommendations
          
          1. âœ… Keep dependencies up to date via Dependabot
          2. âœ… Continue using TrustedTypes for dynamic content
          3. âœ… Maintain security-utils.js for sanitization
          4. âš ï¸ Review and refactor remaining dynamic innerHTML usage
          
          ## Next Audit
          
          **Scheduled:** $(date -d "+3 months" +%Y-%m-%d)
          
          ---
          *Generated automatically by GitHub Actions*
          EOF

      - name: Post to Summary
        if: always()
        run: |
          echo "## âœ… Security Audit Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Quarter:** Q$(($(date +%-m) / 3 + 1)) $(date +%Y)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Audit: ${{ steps.npm-audit.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Security: ${{ steps.eslint-security.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- innerHTML Check: ${{ steps.innerHTML-check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Audit results uploaded to workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Next Audit" >> $GITHUB_STEP_SUMMARY
          echo "$(date -d '+3 months' +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
